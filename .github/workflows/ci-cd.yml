name: CI/CD - Tienda de Mate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job 1: Tests b치sicos
  test:
    name: Tests y Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c칩digo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Instalar dependencias Backend
      working-directory: ./backend
      run: npm install
        
    - name: Ejecutar tests Backend
      working-directory: ./backend
      run: npm test
      
    - name: Tests completados
      run: echo "Todos los tests pasaron correctamente"

  # Job 2: Build Docker
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    
    steps:
    - name: 游닌 Checkout c칩digo
      uses: actions/checkout@v4

    - name: Build Frontend
      run: |
        cd frontend
        docker build -t tienda-mate-frontend .
        echo "Frontend image built successfully"

    - name: Build Backend
      run: |
        cd backend
        docker build -t tienda-mate-backend .
        echo "Backend image built successfully"

  # Job 3: Deploy (simulado)
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deploy to Production 
      run: |
        echo "Deploying to production environment..."
        echo "Production deployment completed!"
        echo "Site available at: https://tienda-mate.com"
        echo "Database: MySQL connected"
        echo "Deployment successful!"